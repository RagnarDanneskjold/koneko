<!doctype html>
<html lang="en">
  <!-- {{{1

    File        : index.html
    Maintainer  : Felix C. Stegerman <flx@obfusk.net>
    Date        : 2020-01-03

    Copyright   : Copyright (C) 2020  Felix C. Stegerman
    Version     : v0.0.1
    License     : GPLv3+

  }}}1 -->
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>koneko REPL</title>
    <style>
      html            { font-size: 1rem; }
      body            { text-align: center; }
      input, textarea { max-width: 100%; }
      a               { text-decoration: none; color: inherit; }
      .middle *       { vertical-align: middle; }
      .small          { font-size: 0.9rem; }
      input, textarea, button, .large {
        font-size: 1.3rem;
      }
      .btn {
        display: inline-block;
        font-size: .875rem;
        line-height: 1.5;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: .2rem;
        padding: .25rem .5rem;
      }
      .btn:hover, .btn:active {
        color: #fff;
        background-color: #007bff;
      }
      .btn:focus {
        box-shadow: 0 0 0 3px rgba(0,123,255,.5);
      }
    </style>
    <script src="https://unpkg.com/xregexp@4.2.4/xregexp-all.js"
      crossorigin="anonymous"
      integrity="sha384-LV0UOCEA94IWb3mkLRhqknyc9aX1zLa+0YgBIHKVBLiMVFzjhnTbJnKbn+ZTOujJ">
    </script>
    <script src="koneko.js"></script>
    <script>
      window.addEventListener("load", async () => {
        const elem = id => document.getElementById(id)
        const [line, cons, st] = ["line", "console", "stack"].map(elem)
        const history = []; let hist_idx = 0
        line.value = stack.value = ""; cons.value = ""
        await koneko.loadPrelude()
        const print = text => {
          cons.value += text + "\n"
          cons.scrollTop = cons.scrollHeight
        }
        koneko.overrides.say = print
        koneko.overrides.ask = s => window.prompt(s)
        koneko.overrides.nya = () => { window.open("nya/tabby.png") }
        const c = koneko.initContext(); let s = koneko.emptyStack()
        await koneko.evalText(":clear-stack '__clear-stack__ def", c, s)
        const f = async () => {                               //  {{{1
          const l = koneko.repl_sugar(line.value)
          hist_idx = 0; line.value = ""
          if (!l) { return }
          if (l != history.slice(-1)[0]) { history.push(l) }
          try {
            s = await koneko.evalText(l, c, s)
          } catch(e) {
            if (e instanceof koneko.KonekoError) {
              print("*** ERROR: " + e.message)
              return
            } else {
              throw e
            }
          }
          st.value  = ">>> " + l + "\n" + "--- STACK ---\n" +
                      s.map(x => koneko.show(x) + "\n").reverse().join("") +
                      "\n" + st.value
        }                                                     //  }}}1
        const hist_scroll = () => {
          line.value = history[history.length - hist_idx] || ""
        }
        const hist_up = () => {
          hist_idx = Math.min(hist_idx + 1, history.length)
          hist_scroll()
        }
        const hist_down = () => {
          hist_idx = Math.max(hist_idx - 1, 0)
          hist_scroll()
        }
        elem("eval").addEventListener("click", f)
        line.addEventListener("keyup", event => {
          if (event.key == "Enter" && !event.shiftKey) { f() }
        })
        line.addEventListener("keydown", event => {           //  {{{1
          switch (event.key) {
            case "Enter":
              if (!event.shiftKey) { event.preventDefault() }
              break
            case "Up":
            case "ArrowUp":
              hist_up()
              break
            case "Down":
            case "ArrowDown":
              hist_down()
              break
          }
        })                                                    //  }}}1
      })
    </script>
  </head>
  <body>
    <div>
      <a href="https://github.com/obfusk/koneko"
        title="&rarr; source @ GitHub">
        <img src="logo.svg" alt="koneko logo" width="150"/>
        <br/>
        <span class="large">
        koneko - a concatenative not-quite-lisp for kittens
        </span>
      </a>
      <br/>
      <br/>
      Koneko (子猫 -- "kitten" in Japanese) is a simple
      concatenative stack-based programming language with lisp
      influences.
      <br/>
      Examples and language documentation:
      <a href="https://github.com/obfusk/koneko#readme" class="btn">
        &rarr; README @ GitHub
      </a>
      <br/>
      <b>NB: work in progress.</b>
    </div>
    <noscript>
      <br/>
      <b>To use this JavaScript implementation of koneko, you'll need
      to enable JavaScript.</b>
      <br/>
      All JavaScript on this page is Free Software.
      <br/>
      Koneko and its standard library are licensed under GPLv3+ and
      LGPLv3+ respectively.
      <br/>
      The only JavaScript loaded from an external source is XRegExp,
      which is loaded from unpkg.com and licensed under MIT.
      <br/>
    </noscript>
    <br/>
    <div class="middle">
      <textarea id="line" rows="1" cols="60" autofocus
        title="use arrow keys for history"
        placeholder="&quot;Hello, World!&quot; say!"></textarea>
      <button id="eval">eval</button>
    </div>
    <br/>
    <div>
      <label>
        Stack:
        <br/>
        <textarea id="stack" rows="10" cols="80" readonly></textarea>
      </label>
    </div>
    <br/>
    <div>
      <label>
        Console:
        <br/>
        <textarea id="console" rows="5" cols="80" readonly></textarea>
      </label>
    </div>
    <br/>
    <hr/>
    <footer>
      <div>
        <a href="https://www.gnu.org/licenses/gpl-3.0.html">
          <img alt="GPLv3+"
               src="https://img.shields.io/badge/license-GPLv3+-blue.svg"/>
        </a>
        <a href="https://www.gnu.org/licenses/lgpl-3.0.html">
          <img alt="LGPLv3+"
               src="https://img.shields.io/badge/license-LGPLv3+-blue.svg"/>
        </a>
        <a href="https://travis-ci.org/obfusk/koneko">
          <img alt="Build Status"
               src="https://travis-ci.org/obfusk/m.svg?branch=master"/>
        </a>
      </div>
      <span class="small">© 2019 Felix C. Stegerman</span>
    </footer>
  </body>
</html>
